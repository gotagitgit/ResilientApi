using Polly.Extensions.Http;
using Polly;
using Microsoft.Extensions.Configuration;
using Resilient.Api.Factories;
using Resilient.Api.Settings;

namespace Resilient.Api.Extensions;

public static class ResilientStrategies
{
    public const string HttpResiliencePolicy = "HttpResiliencePolicy";

    public static IServiceCollection AddResilientStrategies(this IServiceCollection services, IConfiguration configuration)
    {
        var policyRegistry = services.AddPolicyRegistry();

        policyRegistry[HttpResiliencePolicy] = GetResiliencePolicy(configuration);

        services.AddHttpClient(TodoClientFactory.TodosHttpClientName, client =>
        {
            var todoApiSettings = configuration.GetSection(nameof(TodoApiSetting)).Get<TodoApiSetting>();

            client.BaseAddress = new Uri(todoApiSettings.BaseUrl);
        })
        .AddPolicyHandlerFromRegistry(HttpResiliencePolicy);

        return services;
    }

    private static IAsyncPolicy<HttpResponseMessage> GetResiliencePolicy(IConfiguration configuration)
    {
        var resilienceSettings = configuration.GetSection(nameof(ResilienceSettings)).Get<ResilienceSettings>();

        var policies = HttpPolicyExtensions.HandleTransientHttpError()
            .RetryAsync(resilienceSettings.RetryCount)
            .WrapAsync(HttpPolicyExtensions.HandleTransientHttpError()
                .CircuitBreakerAsync(resilienceSettings.ExceptionsAllowedBeforeBreaking, TimeSpan.FromSeconds(5)));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            

        return policies;
    }
}
